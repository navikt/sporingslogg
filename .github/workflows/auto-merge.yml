name: Auto-merge Dependabot Patch Updates

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

jobs:
  automergecheck:
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    outputs:
      label: steps.label_check.outputs.LABEL
      patch: steps.check.outputs.PATCH
    steps:
      - name: Check for dependencies label
        id: label_check
        run: |
          if echo "${{ join(github.event.pull_request.labels.*.name, ' ') }}" | grep -w "dependencies"; then
              echo "LABEL=true"
              //echo "has_dependencies_label=true" >> $GITHUB_OUTPUT
          else
              echo "LABEL=false"
              //echo "has_dependencies_label=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if PR is a patch update
        id: check
        run: |
          title="${{ github.event.pull_request.title }}"
          
          # Match title like: (B|b)ump xxx from x.y.z to x.y.w (same x and y, z != w)
          if [[ "$title" =~ ^(B|b)ump\ .*\ from\ ([0-9]+)\.([0-9]+)\.([0-9]+)\ to\ ([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            from_major=${BASH_REMATCH[1]}
            from_minor=${BASH_REMATCH[2]}
            from_patch=${BASH_REMATCH[3]}
            to_major=${BASH_REMATCH[4]}
            to_minor=${BASH_REMATCH[5]}
            to_patch=${BASH_REMATCH[6]}

            if [[ "$from_major" == "$to_major" && "$from_minor" == "$to_minor" && "$from_patch" != "$to_patch" ]]; then
              echo "PATCH=true" 
              //echo "patch_update=true" >> $GITHUB_OUTPUT
            else
              echo "PATCH=false" 
              //echo "patch_update=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "PATCH=false" 
            //echo "patch_update=false" >> $GITHUB_OUTPUT
          fi

  printOutput:
    name: Print Output
    needs: automergecheck
    runs-on: ubuntu-latest
    steps:
        - name: Print output
          run: |
            echo label : ${{ needs.automergecheck.outputs.label }}
            echo patch : ${{ needs.automergecheck.outputs.patch }}

  automerge:
    name: Auto Merge dependabot
    needs: printOutput
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
        - name: Enable auto-merge
          run: | 
            echo "Hello!"

#          if: needs.automergecheck.outputs.label == 'true' && needs.automergecheck.outputs.patch == 'true'
#          run: gh pr merge "$PR_URL" --auto --merge
#          env:
#            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#            PR_URL: ${{ github.event.pull_request.html_url }}
